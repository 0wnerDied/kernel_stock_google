/*
 * Copyright (C) 2018 Samsung Electronics Co., Ltd.
 *
 * Power gating controls for IPU and TPU blocks.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 and
 * only version 2 as published by the Free Software Foundation.
 */

/* airbrush soc blocks */
#include <linux/airbrush-sm-ctrl.h>
#include "airbrush-power-gating.h"

#define POLL_TIMEOUT 20
int ab_poll_read_check(u32 addr, u32 val)
{
	u32 i, temp_val;

	for (i = 0; i < POLL_TIMEOUT; i++) {
		ABC_READ(addr, &temp_val);
		if (val == temp_val)
			return 0;
	}
	pr_err("%x read, status timeout\n", addr);
	return E_STATUS_TIMEOUT;
}

/*turn on TPU tiles*/
int ab_tpu_tiles_on(void)
{
	ab_poll_read_check(0x10020010, 0xffffffff);

	ABC_WRITE(0x10020010, 0xfffe0000);
	ABC_WRITE(0x10020014, 0x0);
	ab_poll_read_check(0x10020010, 0x0);
	ab_poll_read_check(0x10020014, 0x0);
	ab_poll_read_check(0x10020018, 0xffffffff);

	ABC_WRITE(0x10020018, 0xfffe0000);
	ABC_WRITE(0x1002001c, 0x0);
	ab_poll_read_check(0x10020018, 0x0);
	ab_poll_read_check(0x1002001c, 0x0);

	ABC_WRITE(0x10020008, 0x3);
	ab_poll_read_check(0x10020008, 0x3);

	ABC_WRITE(0x10020008, 0x2);
	ab_poll_read_check(0x10020008, 0x2);

	ABC_WRITE(0x1002000c, 0x0);
	ab_poll_read_check(0x1002000c, 0x0);

	ABC_WRITE(0x10020028, 0x0);
	ABC_WRITE(0x1002002c, 0x0);
	ab_poll_read_check(0x10020028, 0x0);
	ab_poll_read_check(0x10020030, 0x0);

	ABC_WRITE(0x10020020, 0x0);
	ABC_WRITE(0x10020024, 0x0);
	ab_poll_read_check(0x10020020, 0x0);
	ab_poll_read_check(0x10020024, 0x0);

	ABC_WRITE(0x10020008, 0x1);
	ab_poll_read_check(0x10020008, 0x1);

	ABC_WRITE(0x10020038, 0x0);
	ABC_WRITE(0x1002003c, 0x0);
	ab_poll_read_check(0x10020038, 0x1);
	ab_poll_read_check(0x1002003c, 0x1);

	return 0;
}

/*turn off TPU tiles*/
int ab_tpu_tiles_off(void)
{

	ab_poll_read_check(0x10050334, 0x0);

	ABC_WRITE(0x10020008, 0x0);
	ABC_WRITE(0x1002000c, 0x0);
	ab_poll_read_check(0x10020008, 0x0);
	ab_poll_read_check(0x1002000c, 0x0);

	ABC_WRITE(0x10020038, 0x1ffff);
	ABC_WRITE(0x1002003c, 0x0);

	ABC_WRITE(0x10020020, 0xffff);
	ABC_WRITE(0x10020024, 0x0);
	ab_poll_read_check(0x10020020, 0xffff);
	ab_poll_read_check(0x10020024, 0x0);

	ABC_WRITE(0x10020028, 0x1ffff);
	ABC_WRITE(0x1002002c, 0x0);
	ab_poll_read_check(0x10020028, 0x1ffff);
	ab_poll_read_check(0x1002002c, 0x0);

	ab_poll_read_check(0x10020030, 0x1ffff);
	ABC_WRITE(0x10020018, 0x1ffff);
	ABC_WRITE(0x1002001c, 0x0);
	ab_poll_read_check(0x10020018, 0x1ffff);
	ab_poll_read_check(0x1002001c, 0x0);

	ABC_WRITE(0x10020010, 0x1ffff);
	ABC_WRITE(0x10020014, 0x0);
	ab_poll_read_check(0x10020010, 0x1ffff);
	ab_poll_read_check(0x10020014, 0x0);

	return 0;
}

/* Power on i/o and all 14 cores*/
int ab_ipu_cores_on(void)
{
	ABC_WRITE(0x10200080, 0x1);
	ABC_WRITE(0x10200018, 0x3fff);
	ABC_WRITE(0x10200020, 0xffff);
	ABC_WRITE(0x10200028, 0xf);

	/* powering on i/o block */
	ABC_WRITE(0x1020006c, 0x0);
	ABC_WRITE(0x10200068, 0x0);
	ABC_WRITE(0x10200038, 0x1);
	ABC_WRITE(0x10200038, 0x0);
	ABC_WRITE(0x10200078, 0x0);
	ABC_WRITE(0x10200038, 0x1);
	ABC_WRITE(0x10200070, 0x0);

	/* pmu_issue_cmu_reset=1 */
	ABC_WRITE(0x10200080, 0x0);
	ABC_WRITE(0x10200090, 0x1);

	/* powering on core pair 0 */
	ABC_WRITE(0x10200054, 0x3ffe);
	ABC_WRITE(0x10200050, 0x3ffe);
	ABC_WRITE(0x10200054, 0x3ffc);
	ABC_WRITE(0x10200050, 0x3ffc);
	ABC_WRITE(0x10200040, 0x1);
	ABC_WRITE(0x10200040, 0x0);
	ABC_WRITE(0x10200060, 0x3ffc);
	ABC_WRITE(0x10200040, 0x1);
	ABC_WRITE(0x10200058, 0x3ffc);

	/* powering on core pair 1 */
	ABC_WRITE(0x10200054, 0x3ff8);
	ABC_WRITE(0x10200050, 0x3ff8);
	ABC_WRITE(0x10200054, 0x3ff0);
	ABC_WRITE(0x10200050, 0x3ff0);
	ABC_WRITE(0x10200040, 0x2);
	ABC_WRITE(0x10200040, 0x0);
	ABC_WRITE(0x10200060, 0x3ff0);
	ABC_WRITE(0x10200040, 0x2);
	ABC_WRITE(0x10200058, 0x3ff0);

	/* powering on core pair 2 */
	ABC_WRITE(0x10200054, 0x3fe0);
	ABC_WRITE(0x10200050, 0x3fe0);
	ABC_WRITE(0x10200054, 0x3fc0);
	ABC_WRITE(0x10200050, 0x3fc0);
	ABC_WRITE(0x10200040, 0x3);
	ABC_WRITE(0x10200040, 0x0);
	ABC_WRITE(0x10200060, 0x3fc0);
	ABC_WRITE(0x10200040, 0x3);
	ABC_WRITE(0x10200058, 0x3fc0);

	/* powering on core pair 3 */
	ABC_WRITE(0x10200054, 0x3f80);
	ABC_WRITE(0x10200050, 0x3f80);
	ABC_WRITE(0x10200054, 0x3f00);
	ABC_WRITE(0x10200050, 0x3f00);
	ABC_WRITE(0x10200040, 0x4);
	ABC_WRITE(0x10200040, 0x0);
	ABC_WRITE(0x10200060, 0x3f00);
	ABC_WRITE(0x10200040, 0x4);
	ABC_WRITE(0x10200058, 0x3f00);

	/* powering on core pair 4 */
	ABC_WRITE(0x10200054, 0x3e00);
	ABC_WRITE(0x10200050, 0x3e00);
	ABC_WRITE(0x10200054, 0x3c00);
	ABC_WRITE(0x10200050, 0x3c00);
	ABC_WRITE(0x10200040, 0x5);
	ABC_WRITE(0x10200040, 0x0);
	ABC_WRITE(0x10200060, 0x3c00);
	ABC_WRITE(0x10200040, 0x5);
	ABC_WRITE(0x10200058, 0x3c00);

	/* powering on core pair 5 */
	ABC_WRITE(0x10200054, 0x3800);
	ABC_WRITE(0x10200050, 0x3800);
	ABC_WRITE(0x10200054, 0x3000);
	ABC_WRITE(0x10200050, 0x3000);
	ABC_WRITE(0x10200040, 0x6);
	ABC_WRITE(0x10200040, 0x0);
	ABC_WRITE(0x10200060, 0x3000);
	ABC_WRITE(0x10200040, 0x6);
	ABC_WRITE(0x10200058, 0x3000);

	/* powering on core pair 6 */
	ABC_WRITE(0x10200054, 0x2000);
	ABC_WRITE(0x10200050, 0x2000);
	ABC_WRITE(0x10200054, 0x0);
	ABC_WRITE(0x10200050, 0x0);
	ABC_WRITE(0x10200040, 0x7);
	ABC_WRITE(0x10200040, 0x0);
	ABC_WRITE(0x10200060, 0x0);
	ABC_WRITE(0x10200040, 0x7);
	ABC_WRITE(0x10200058, 0x0);
	ABC_WRITE(0x10200028, 0x1);
	ABC_WRITE(0x10200020, 0x0);

	return 0;
}

/*power off all 14 cores and i/o*/
int ab_ipu_cores_off(void)
{

	ABC_WRITE(0x10200018, 0x3fff);
	ABC_WRITE(0x10200020, 0xffff);
	ABC_WRITE(0x10200028, 0xf);

	/* powering off core pair 6 */
	ABC_WRITE(0x10200058, 0x3000);
	ABC_WRITE(0x10200040, 0x0);
	ABC_WRITE(0x10200060, 0x3000);
	ABC_WRITE(0x10200040, 0x7);
	ABC_WRITE(0x10200040, 0x6);
	ABC_WRITE(0x10200054, 0x3000);
	ABC_WRITE(0x10200050, 0x3000);

	/* powering off core pair 5 */
	ABC_WRITE(0x10200058, 0x3c00);
	ABC_WRITE(0x10200040, 0x0);
	ABC_WRITE(0x10200060, 0x3c00);
	ABC_WRITE(0x10200040, 0x6);
	ABC_WRITE(0x10200040, 0x5);
	ABC_WRITE(0x10200054, 0x3c00);
	ABC_WRITE(0x10200050, 0x3c00);

	/* powering off core pair 4 */
	ABC_WRITE(0x10200058, 0x3f00);
	ABC_WRITE(0x10200040, 0x0);
	ABC_WRITE(0x10200060, 0x3f00);
	ABC_WRITE(0x10200040, 0x5);
	ABC_WRITE(0x10200040, 0x4);
	ABC_WRITE(0x10200054, 0x3f00);
	ABC_WRITE(0x10200050, 0x3f00);

	/* powering off core pair 3 */
	ABC_WRITE(0x10200058, 0x3fc0);
	ABC_WRITE(0x10200040, 0x0);
	ABC_WRITE(0x10200060, 0x3fc0);
	ABC_WRITE(0x10200040, 0x4);
	ABC_WRITE(0x10200040, 0x3);
	ABC_WRITE(0x10200054, 0x3fc0);
	ABC_WRITE(0x10200050, 0x3fc0);

	/* powering off core pair 2 */
	ABC_WRITE(0x10200058, 0x3ff0);
	ABC_WRITE(0x10200040, 0x0);
	ABC_WRITE(0x10200060, 0x3ff0);
	ABC_WRITE(0x10200040, 0x3);
	ABC_WRITE(0x10200040, 0x2);
	ABC_WRITE(0x10200054, 0x3ff0);
	ABC_WRITE(0x10200050, 0x3ff0);

	/* powering off core pair 1 */
	ABC_WRITE(0x10200058, 0x3ffc);
	ABC_WRITE(0x10200040, 0x0);
	ABC_WRITE(0x10200060, 0x3ffc);
	ABC_WRITE(0x10200040, 0x2);
	ABC_WRITE(0x10200040, 0x1);
	ABC_WRITE(0x10200054, 0x3ffc);
	ABC_WRITE(0x10200050, 0x3ffc);

	/* powering off core pair 0 */
	ABC_WRITE(0x10200058, 0x3fff);
	ABC_WRITE(0x10200040, 0x0);
	ABC_WRITE(0x10200060, 0x3fff);
	ABC_WRITE(0x10200040, 0x1);
	ABC_WRITE(0x10200040, 0x0);
	ABC_WRITE(0x10200054, 0x3fff);
	ABC_WRITE(0x10200050, 0x3fff);

	/* powering off i/o block */
	ABC_WRITE(0x10200090, 0x0);
	ABC_WRITE(0x10200070, 0x1);
	ABC_WRITE(0x10200038, 0x0);
	ABC_WRITE(0x10200078, 0x1);
	ABC_WRITE(0x10200038, 0x1);
	ABC_WRITE(0x10200038, 0x0);
	ABC_WRITE(0x1020006c, 0x1);
	ABC_WRITE(0x10200068, 0x1);
	ABC_WRITE(0x10200028, 0x1);
	ABC_WRITE(0x10200020, 0x0);

	return 0;
}
